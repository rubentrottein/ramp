name: CI/CD - RAMP Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [created]

jobs:
  test-and-release:
    runs-on: windows-latest
    defaults:
      run:
        shell: cmd

    steps:
      - name: ğŸ§¾ Cloner le repo
        uses: actions/checkout@v4

      - name: ğŸ“‚ Lister les fichiers
        run: dir

      - name: ğŸ§ª Lancer le serveur
        run: start_server.bat

      - name: â±ï¸ Attendre le dÃ©marrage (5 sec)
        run: timeout /t 5

      - name: ğŸŒ Tester localhost
        run: curl http://localhost || echo "âš ï¸ Le serveur nâ€™a pas rÃ©pondu"

      - name: ğŸ§¹ ArrÃªter le serveur
        run: stop_server.bat

      - name: ğŸ” Analyse syntaxique PHP
        run: |
          for /R %%f in (*.php) do php -l "%%f"

      - name: ğŸ“¦ Zipper le projet
        run: powershell -Command "Compress-Archive -Path * -DestinationPath ramp-release.zip"

      - name: ğŸš€ Publier la release (si tag)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: ramp-release.zip
